<?php 
// $Id: sogintegration.module

/**
* @file
* Custom hooks for SOG member signup/creation
*/

//error_reporting(E_ALL);
$mdpassword = "CHANGE THIS TO MAJORDOMO MAILINGLIST PASSWORD";

/**
 * Hook into CiviCRM Contribution page (Online Mitgliederformular)
 */
function sogintegration_civicrm_postProcess($formName, &$form ) {
    if ($formName == "CRM_Contribute_Form_Contribution_Confirm" && $form->_values['title'] == "Aktive Mitgliedschaft") {
        
        // get parameters from form
        $firstName = t($form->_submitValues['first_name']);
        $lastName = t($form->_submitValues['last_name']);
        $email = t($form->_params['email-5']);
        $lokalgruppe = t($form->_params['custom_11']);
        
        // generate accounts, etc.
        sogintegration_addOpenAtriumUser($firstName, $lastName, $email, $lokalgruppe);
        sogintegration_addToLgMailinglist($lokalgruppe, $email);
        //sogintegration_addToNewsletter($username, $email);
        
        sogintegration_notifyLokalkoordinator($firstName, $lastName, $email, $lokalgruppe);
    }
}


/**
 * Insert the user into the openatrium user table 
 */
function sogintegration_addOpenAtriumUser($firstName, $lastName, $email, $lokalgruppe) {
    // generate new user credentials
    $username = sogintegration_selectUsername($firstName, $lastName);
    $password = sogintegration_generatePassword(8);

    $query = "INSERT INTO `users` (`uid`, `name`, `pass`, `mail`, `mode`, `sort`, `threshold`, `theme`, `signature`, `signature_format`, `created`, `access`, `login`, `status`, `timezone`, `language`, `picture`, `init`, `data`) VALUES (NULL, '%s', '%s', '%s', '0', '0', '0', '', '', '0', %d, '0', '0', '0', '3600', '', '', '', NULL)";
    // status = 0 -> account needs to be enabled manually
    
    $result = db_query($query, $username, md5($password), $email, time());
    
    sogintegration_sendWelcomeMail($firstName, $username, $email, $password);
    drupal_set_message("Account '".$username."' erstellt (ID=$uid)");
    
    $uid = sogintegration_getUID($username);
    sogintegration_addToOpenAtriumGroups($uid, $lokalgruppe);
}


/**
 * Get the ID of the user we just inserted
 */
function sogintegration_getUID($username) {
    $result = db_fetch_object(db_query("SELECT uid FROM `users` WHERE name = '%s'", $username));
    return $result->uid;
}


/**
 * Add the user to the relevant OA groups.
 */
function sogintegration_addToOpenAtriumGroups($uid, $lokalgruppe) {
    /** Insert the User into the organic group named 'Allgemein' */
    $query = "SELECT nid FROM `openatrium_node` WHERE title = 'Allgemein' AND type='group'";
    $result = db_fetch_object(db_query($query));
    $nid = $result->nid;

    $query_joinOG = "INSERT INTO `openatrium_og_uid` (`nid`, `og_role`, `is_active`, `is_admin`, `uid`, `created`, `changed`) VALUES (%d, 0, 1, 0, %d, %d, %d)";
    
    $result = db_query($query_joinOG, $nid, $uid, time(), time());

    /** Insert the User into the specific Lokalgruppe */
    $query = "SELECT nid FROM `openatrium_node` WHERE title = 'LG %s' AND type='group'";
    $result = db_query($query, $lokalgruppe);
    /** Just insert if we found a group with this name */
    if (db_result($result)) {
        $res = db_fetch_object($result);
        $result = db_query($query_joinOG, $res->nid, $uid, time(), time());
    }
}


/**
 * Generate a unique username.
 * Tests whether the username is already taken. If so, appends 
 * an increasing number until the username does not already exist
 */
function sogintegration_selectUsername($firstName, $lastName) {
    $username = trim($firstName) . " " . trim($lastName);

    $foundUsername = false;
    $i = 0;
    while (!$foundUsername) {
        if ($i == 0) {
            $param = $username;
        } else {
            $param = $username.$i;
        }
        $result = db_result(db_query("SELECT uid FROM `users` WHERE name = '%s'", $param));

        if ($result == FALSE) {
            $foundUsername = true;
            if ($i != 0)
                $username = $username . $i;
        } else {
            ++$i;
        }
    }

    // normalize special chars in username
    /*$usernameEasy = str_replace("ä", "ae", $username);
    $usernameEasy = str_replace("ö", "oe", $usernameEasy);
    $usernameEasy = str_replace("ü", "ue", $usernameEasy);
    $usernameEasy = str_replace("ß", "ss", $usernameEasy);
    $usernameEasy = str_replace(" ", ".", $usernameEasy);*/
    
    return $username;
}


/**
 * Generate a new random password
 */
function sogintegration_generatePassword($length = 8) {
    $password = "";

    $possible = "2346789bcdfghjkmnpqrtvwxyzBCDFGHJKLMNPQRTVWXYZ";

    $maxlength = strlen($possible);
  
    // check for length overflow and truncate if necessary
    if ($length > $maxlength) {
      $length = $maxlength;
    }
    
    $i = 0; 
    while ($i < $length) { 
      // pick a random character from the possible ones
      $char = substr($possible, mt_rand(0, $maxlength-1), 1);
        
      // have we already used this character in $password?
      if (!strstr($password, $char)) { 
        // no, so it's OK to add it onto the end of whatever we've already got...
        $password .= $char;
        $i++;
      }
    }

    return $password;
}


/**
 * Send a mail to the user.
 * This is send only for OpenAtrium account details, a welcome mail is send through CiviCRM!
 */
function sogintegration_sendWelcomeMail($firstName, $username, $email, $password) {    
    $text = '
<html><head><title></title></head><body>
Hallo ' . $firstName . ',<br />
Wir freuen uns sehr, dich als neues Mitglied bei Studieren ohne Grenzen begrüßen zu dürfen.<br />
<br />
Damit du direkt einsteigen und mitarbeiten kannst, haben wir dir automatisch einen Zugang für unsere Onlineplattform OpenAtrium erstellt. Über diese Plattform tauschen wir wichtige Nachrichten, Informationen und Dateien aus und diskutieren fleißig.<br />
Dein Account wird freigeschaltet, sobald dein Lokalkoordinator bestätigt hat, dass du tatsächlich bei Studieren Ohne Grenzen aktiv bist.
<br /><br />
Um dich bei OpenAtrium einzuloggen, klicke entweder ganz unten in der Fußzeile unserer Webseite auf "OpenAtrium" oder folge diesem Link: http://www.studieren-ohne-grenzen.org/atrium <br />
<br />
Du kannst dich dann mit folgenden Daten einloggen:<br />

Benutzername: ' . $username . '<br />
Password:     ' . $password . '<br />
<br />
Viele Grüße,<br />
Das SOG-IT-Team<br />
it@studieren-ohne-grenzen.org
</body>
</html>
';
    $text = wordwrap($text, 70);
    # $extra= 'From: it@studieren-ohne-grenzen.org' . "\r\n" . 'MIME-Version: 1.0' . "\r\n" . 'Content-Type: text/plain; charset=ISO-8859-1' . "\r\n" . 'Content-Transfer-Encoding: quoted-printable';
    $extra = "From: it@studieren-ohne-grenzen.org\nContent-Type: text/html; charset=UTF-8\nContent-Transfer-Encoding: 8bit";
    @mail($email, "Zugangsdaten OpenAtrium - Studieren Ohne Grenzen", $text, $extra);
}


/**
 * Inserts the new user into the mailing list of the specific Lokalgruppe
 */
function sogintegration_addToLgMailinglist($lokalgruppe, $email) {
    $mdrecipient = "majordomo@s-o-g.org";
    $mdfrom = "atrium@studieren-ohne-grenzen.org"; // erhaelt eventuelle fehlermeldungen von majordomo

    $listmail = "approve " . $mdpassword . " subscribe " . strtolower($lokalgruppe) . "-s-o-g-org " . $email;
    @mail($mdrecipient, "Automated Majordomo Subscription", $listmail, "From: " . $mdfrom);
    
    drupal_set_message("$email wurde auf Lokalgruppen-Verteiler gesetzt.");
}


/**
 * Send email to Lokalkoordinator of the Lokalgruppe to inform about new member
 */
function sogintegration_notifyLokalkoordinator($vorname, $name, $email, $standort) {
        $text = "Soeben hat sich ein neues Mitglied fuer Deine Lokalgruppe angemeldet.<br>
                Das neue Mitglied ist schon auf dem Lokalgruppen-Verteiler eingetragen und hat einen OpenAtrium-Account erhalten.<br><br>
                <b>Achtung: </b> Der OA-Account des Mitglieds muss erst von der Mitgliederbetreuung aktiviert werden. Bitte bestätige am Besten jetzt direkt formlos per Email an <mitglieder@studieren-ohne-grenzen.org>, dass ".$vorname." ".$name." tatsächlich in eurer LG aktiv ist!
                <br><br>
                Hier die Daten des neuen Mitglieds:<br>";
        $text .= "Vorname: ".$vorname."<br>";
        $text .= "Nachname: ".$name."<br>";
        $text .= "Mail: ".$email."<br>";
        $text .= "Standort: ".$standort."<br>";
        $extra = "From:mitglieder@studieren-ohne-grenzen.org\nContent-Type: text/html; charset=UTF-8\nContent-Transfer-Encoding: 8bit";
        @mail(strtolower($standort)."@studieren-ohne-grenzen.org","Neuanmeldung in deiner Lokalgruppe",$text,$extra);
}

?>
